# UrlFetchã‚’ä½¿ç”¨ã—ãŸGoogle APIã®å®Ÿè¡Œ

Google Apps Script (GAS) ã‹ã‚‰Google APIã‚’å‘¼ã³å‡ºã™æ–¹æ³•ã«ã¯ã€ä¸»ã«ã€Œæ‹¡å¼µã‚µãƒ¼ãƒ“ã‚¹ã€ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã¨ã€ã€Œ`UrlFetchApp`ã‚µãƒ¼ãƒ“ã‚¹ã€ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã®2ã¤ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€å¾Œè€…ã®`UrlFetchApp`ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã‚’æ¨å¥¨ã—ã€ãã®ç†ç”±ã¨å…·ä½“çš„ãªå®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

---

## ğŸš€ ãªãœUrlFetchAppã‚’åˆ©ç”¨ã™ã‚‹ã®ã‹

`CalendarApp`ã‚„`GmailApp`ã®ã‚ˆã†ãªçµ„ã¿è¾¼ã¿ã‚µãƒ¼ãƒ“ã‚¹ã¨ã¯åˆ¥ã«ã€GASã§ã¯Google Drive APIã‚„YouTube Data APIãªã©ã®ä»–ã®Google APIã‚’ã€Œæ‹¡å¼µã‚µãƒ¼ãƒ“ã‚¹ã€ã¨ã—ã¦æœ‰åŠ¹åŒ–ã—ã¦åˆ©ç”¨ã§ãã¾ã™ã€‚ã“ã‚Œã¯ä¸€è¦‹ä¾¿åˆ©ã§ã™ãŒã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç®¡ç†ã‚„é‹ç”¨ã®è¦³ç‚¹ã‹ã‚‰ã„ãã¤ã‹ã®èª²é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€APIã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã‚’**`UrlFetchApp`ã«çµ±ä¸€ã™ã‚‹**ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚ä¸»ãªç†ç”±ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

* **APIå®Ÿè¡Œã®å¯è¦–æ€§ãŒãªã„ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆ©ç”¨ã‚’é¿ã‘ã‚‹ãŸã‚**
  * æ‹¡å¼µã‚µãƒ¼ãƒ“ã‚¹ã¯ã€GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç´ã¥ã**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®GCPï¼ˆGoogle Cloud Platformï¼‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**ã§æœ‰åŠ¹ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚
  * ã“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€APIã®å®Ÿè¡Œå›æ•°ã‚„ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ¼ãƒˆã€å‰²ã‚Šå½“ã¦ï¼ˆã‚¯ã‚©ãƒ¼ã‚¿ï¼‰ã®çŠ¶æ³ãªã©ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒæä¾›ã•ã‚Œã¦ãŠã‚‰ãšã€**åˆ©ç”¨çŠ¶æ³ãŒãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹**ã«ãªã‚ŠãŒã¡ã§ã™ã€‚
  * å®‰å®šã—ãŸé‹ç”¨ã®ãŸã‚ã«ã¯ã€APIã®ä½¿ç”¨çŠ¶æ³ã‚’ç›£è¦–ãƒ»åˆ†æã§ãã‚‹**æ¨™æº–ã®GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**ã«åˆ‡ã‚Šæ›¿ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯åˆ©ç”¨ã—ã¾ã›ã‚“ã€‚

* **æ‹¡å¼µã‚µãƒ¼ãƒ“ã‚¹ã§ã¯å¯¾å¿œã—ã¦ã„ãªã„APIãŒã‚ã‚‹ãŸã‚**
  * GoogleãŒæä¾›ã™ã‚‹å…¨ã¦ã®APIãŒGASã®æ‹¡å¼µã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦æä¾›ã•ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
  * å°†æ¥çš„ã«éå¯¾å¿œã®APIã‚’åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒå‡ºãŸå ´åˆã«ã€`UrlFetchApp`ã‚’ä½¿ã£ãŸå‘¼ã³å‡ºã—æ–¹æ³•ã‚‚åˆ¥é€”å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®çµ±ä¸€æ€§ãŒå¤±ã‚ã‚Œã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ç†ç”±ã‹ã‚‰ã€APIã‚¢ã‚¯ã‚»ã‚¹ã®æ–¹æ³•ã¯`UrlFetchApp`ã«çµ±ä¸€ã—ã€èªè¨¼ã«ã¯OAuth2ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¡ç”¨ã—ã¾ã™ã€‚

---

## ğŸ”§ å®Ÿè£…æ–¹æ³•ï¼šUrlFetchApp ã¨ OAuth2ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

`UrlFetchApp`ã§Google APIã‚’å‘¼ã³å‡ºã™ã«ã¯ã€APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ­£å½“ãªã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’è¨¼æ˜ã™ã‚‹ãŸã‚ã®**èªè¨¼**å‡¦ç†ãŒå¿…è¦ã§ã™ã€‚ã“ã“ã§ã¯ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§åºƒãåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹`apps-script-oauth2`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦OAuth2èªè¨¼ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

### 1. OAuth2ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ 

ã¾ãšã€GASã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«`apps-script-oauth2`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã—ã¾ã™ã€‚

1. GASã‚¨ãƒ‡ã‚£ã‚¿ã®å·¦å´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã®æ¨ªã«ã‚ã‚‹`+`ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
2. ã€Œã‚¹ã‚¯ãƒªãƒ—ãƒˆIDã€ã®å…¥åŠ›æ¬„ã«ã€ä»¥ä¸‹ã®IDã‚’è²¼ã‚Šä»˜ã‘ã¦ã€Œæ¤œç´¢ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    > `1B7FSrk57A1B1Ld3gsKAzPL2iF4bMUlB4XF_L0NnStnkKP-pp2_soXjpM`
3. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ï¼ˆé€šå¸¸ã¯æœ€æ–°ç‰ˆã‚’æ¨å¥¨ï¼‰ã€ã€Œè¿½åŠ ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
    * è­˜åˆ¥å­ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®`OAuth2`ã®ã¾ã¾ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

### 2. èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã®ä½œæˆ

æ¬¡ã«ã€OAuth2ã®èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’ç®¡ç†ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ã©ã®Google APIã‚’ã€ã©ã®æ¨©é™ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—ï¼‰ã§åˆ©ç”¨ã™ã‚‹ã‹ã‚’å®šç¾©ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

```javascript
/**
 * OAuth2èªè¨¼ã®ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆãƒ»è¨­å®šã—ã¾ã™ã€‚
 * @return {OAuth2.Service} èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function getOAuth2Service() {
  // åˆ©ç”¨ã™ã‚‹APIã«å¿œã˜ã¦ã€æ‰¿èªç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹åã‚’æŒ‡å®šã—ã¾ã™ã€‚
  const serviceName = 'googleApiWithUrlFetch';

  // æ¨™æº–ã®GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½œæˆã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚
  // ã“ã‚Œã‚‰ã®æƒ…å ±ã¯GCPã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã€ŒAPIã¨ã‚µãƒ¼ãƒ“ã‚¹ > èªè¨¼æƒ…å ±ã€ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚
  return OAuth2.createService(serviceName)
    // èªè¨¼æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹å ´æ‰€ã‚’æŒ‡å®šã—ã¾ã™ã€‚ï¼ˆé€šå¸¸ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ï¼‰
    .setCache(CacheService.getUserCache())
    .setLock(LockService.getUserLock())
    
    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®š
    .setClientId('YOUR_CLIENT_ID.apps.googleusercontent.com')
    .setClientSecret('YOUR_CLIENT_SECRET')
    
    // ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã•ã‚ŒãŸå¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹URL
    .setCallbackFunction('authCallback')
    
    // èªè¨¼æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¹ãƒˆã‚¢ã‚’æŒ‡å®š
    .setPropertyStore(PropertiesService.getUserProperties())
    
    // APIã«å¿…è¦ãªæ¨©é™ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—ï¼‰ã‚’è¦æ±‚ã—ã¾ã™ã€‚
    // ä¾‹ï¼šGoogle Drive APIã®èª­ã¿å–ã‚Šå°‚ç”¨æ¨©é™
    .setScope('[https://www.googleapis.com/auth/drive.readonly](https://www.googleapis.com/auth/drive.readonly)')
    
    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚ï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ï¼‰
    .setParam('access_type', 'offline')
    .setParam('prompt', 'consent');
}

/**
 * èªè¨¼ãƒ•ãƒ­ãƒ¼å®Œäº†å¾Œã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã§ã™ã€‚
 * @param {object} request èªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±
 */
function authCallback(request) {
  const service = getOAuth2Service();
  const isAuthorized = service.handleCallback(request);
  if (isAuthorized) {
    return HtmlService.createHtmlOutput('èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸã€‚ã‚¿ãƒ–ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚');
  } else {
    return HtmlService.createHtmlOutput('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  }
}
